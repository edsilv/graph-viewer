<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>oeuvre</title>
    <style>

        * {
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        g.node text {
            font-size: 20px;
            font-family: 'PT Sans', sans-serif;
            pointer-events: none;
            text-anchor: middle;
        }

        g.node text.category {
            font-weight: bold;
        }

        g.node text.creativeWork {

        }

        line.link {
            fill: none;
            stroke: #e3dfe3;
            stroke-width: 1.5px;
        }

    </style>
    <link href='http://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
</head>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="bower_components/lodash-compat/lodash.js"></script>
<script>

    var width = window.innerWidth,
        height = window.innerHeight;

    var graph = [
                    { "type": "creativeWork", "form": "MovingImage", "theme": "Memory, Exile", "id": "Wunschendorf", "name": "Wunschendorf" },
                    { "type": "creativeWork", "form": "Text", "theme": "Memory", "id": "AndOnlyFineThreads", "name": "AndOnlyFineThreads" },
                    { "type": "creativeWork", "form": "MovingImage", "theme": "Identity, TheSea", "id": "TheShore", "name": "The Shore" },
                    { "type": "creativeWork", "form": "MovingImage", "theme": "Identity, Exile", "id": "ScholtzsHouse", "name": "Scholtz's House" },
                    { "type": "creativeWork", "form": "MovingImage", "theme": "Identity, Mining", "id": "LaMortedlarbe", "name": "La Morte d'larbe" },
                    { "type": "creativeWork", "form": "Text", "theme": "Storytelling", "id": "TheArtofNarrative", "name": "The Art of Narrative" },
                    { "type": "theme", id: "Memory", "name": "Memory" },
                    { "type": "theme", id: "Identity", "name": "Identity" },
                    { "type": "theme", id: "Mining", "name": "Mining" },
                    { "type": "theme", id: "Exile", "name": "Exile" },
                    { "type": "theme", id: "Storytelling", "name": "Storytelling" },
                    { "type": "theme", id: "TheSea", "name": "The Sea" },
                    { "type": "form", id: "MovingImage", "name": "Film" },
                    { "type": "form", id: "Text", "name": "Text" }
                ];

    var svg = d3.select('body').append('svg').attr('viewBox', '0 0 ' + width + ' ' + height);

    var force = d3.layout.force()
            .size([width, height])
            .gravity(.05)
            .distance(250)
            .charge(-1000)
            .friction(.6)
            .on('tick', tick);

    var theme = true;

    svg.on('click', function() {
        theme = !theme;
        update();
    });

    var link = svg.selectAll('.link');
    var node = svg.selectAll('.node');

    function update() {
        var result;

        if (theme){
            result = getConnections("theme");
        } else {
            result = getConnections("form");
        }

        // Restart the force layout.
        force.nodes(result.nodes)
                .links(result.links)
                .start();

        // Update links.
        link = link.data(result.links);

        link.exit().remove();

        link.enter().insert("line")
                .attr("class", "link");

        // Update nodes.
        node = node.data(result.nodes, function(d) {
            return d.id;
        });

        node.exit().remove();

        var nodeEnter = node.enter()
                .append("g")
                .attr("class", "node")
                .on("click", click)
                .call(force.drag);

        nodeEnter.append("text")
                .attr("class", function(d){
                    if(d.type === "creativeWork"){
                        return 'creativeWork';
                    }
                    return 'category';
                })
                .attr("fill", color)
                .attr("dy", ".35em")
                .text(function(d) { return d.name; });
    }

    function getConnections(type) {

        // first get an array of all creativeworks and types combined
        var nodes = _.filter(graph, function(n) {
            return n.type === "creativeWork" || n.type === type;
        });

        // now get an array of how each creativework and type is connected
        var links = [];

        for (var i = 0; i < nodes.length; i++){
            var n = nodes[i];

            if (n.type.toLowerCase() === "creativework"){
                var t = n[type].split(',');
                for (var j = 0; j < t.length; j++){
                    // for each connection, push a new object to links
                    links.push({
                        "source": i,
                        "target": _.findIndex(nodes, function(x) {
                            return x.id.toLowerCase() === t[j].trim().toLowerCase();
                        })
                    });
                }
            }
        }

        return {
            nodes: nodes,
            links: links
        };
    }

    function tick() {

        link.attr('x1', function(d) { return d.source.x; })
                .attr('y1', function(d) { return d.source.y; })
                .attr('x2', function(d) { return d.target.x; })
                .attr('y2', function(d) { return d.target.y; });

        node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    }

    function color(d) {
        return d.type === "creativeWork" ? "#9a969a" : "#535253";
    }

    function click(d) {
        if (d3.event.defaultPrevented) return; // ignore drag
        console.log(d.id);
        update();
    }

    update();

</script>
</body>
</html>